import React, { useState, useEffect, useRef } from 'react';
import { CloudRain, Sun, Moon, Video, RefreshCw, AlertCircle, Droplets, MapPin, Navigation, Umbrella } from 'lucide-react';

// --- è¨­å®šå€ ---
// å¡«å…¥ä½ çš„ä¸­å¤®æ°£è±¡å±€ API Key (è‹¥ç‚ºç©ºå­—ä¸²ï¼Œå°‡è‡ªå‹•ä½¿ç”¨ Open-Meteo å…è²»åœ–è³‡)
// æ ¼å¼é€šå¸¸ç‚º: 'CWA-CF841C96-88BC-4532-82C4-B7BF7AD68209'
const CWA_API_KEY = ""; 

// çƒå ´è³‡æ–™è¨­å®š (åŒ…å«å°æ‡‰çš„æ°£è±¡å±€æ¸¬ç«™ ID)
const COURTS = [
  {
    id: 'xinsheng',
    name: 'æ–°ç”Ÿå…¬åœ’ç±ƒçƒå ´',
    subName: 'å°åŒ—å¸‚ æ°‘æ—å»ºåœ‹è·¯å£ç›£æ¸¬é»',
    lat: 25.0683,
    lon: 121.5332,
    camUrl: "https://c01.twipcam.com/cam/snapshot/tpe-000241.jpg",
    // å°æ‡‰æ°£è±¡å±€æ¸¬ç«™: å¤§ç›´ (C0A9F0) æˆ– è‡ºåŒ— (466920)ï¼Œé€™è£¡é¸å¤§ç›´è¼ƒè¿‘
    stationId: "C0A9F0", 
    locationName: "ä¸­å±±å€" // ç”¨æ–¼é å ±
  },
  {
    id: 'chongyang',
    name: 'é‡é™½æ©‹å ¤å¤–ç±ƒçƒå ´',
    subName: 'æ–°åŒ—å¸‚ ä¸‰é‡å€é‡é™½æ©‹ç›£æ¸¬é»',
    lat: 25.0845,
    lon: 121.4992,
    camUrl: "https://c01.twipcam.com/cam/snapshot/nwt-000249.jpg",
    // å°æ‡‰æ°£è±¡å±€æ¸¬ç«™: ä¸‰é‡ (C0AD30)
    stationId: "C0AD30",
    locationName: "ä¸‰é‡å€" // ç”¨æ–¼é å ±
  }
];

export default function App() {
  const [currentCourtIndex, setCurrentCourtIndex] = useState(0);
  const currentCourt = COURTS[currentCourtIndex];

  const [imageUrl, setImageUrl] = useState(`${currentCourt.camUrl}?t=${Date.now()}`);
  const [weather, setWeather] = useState<any>(null);
  const [brightness, setBrightness] = useState<number>(0);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [lastUpdated, setLastUpdated] = useState('');
  const [dataSource, setDataSource] = useState<'CWA' | 'Open-Meteo'>('Open-Meteo');
  
  const imgRef = useRef<HTMLImageElement>(null);

  // åˆ‡æ›çƒå ´æ™‚é‡ç½®
  useEffect(() => {
    setLoading(true);
    setWeather(null);
    setBrightness(0);
    setError('');
    refreshAll();
  }, [currentCourtIndex]);

  // 1. æŠ“å–æ°£è±¡å±€è³‡æ–™ (å„ªå…ˆ)
  const fetchCwaData = async () => {
    if (!CWA_API_KEY) return false;
    
    try {
      // ä½¿ç”¨ O-A0002-001 (é›¨é‡è§€æ¸¬è³‡æ–™)
      const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0002-001?Authorization=${CWA_API_KEY}&StationId=${currentCourt.stationId}`;
      const response = await fetch(url);
      const data = await response.json();

      if (data.success === "true" && data.records.Station.length > 0) {
        const stationData = data.records.Station[0];
        const rainElement = stationData.RainfallElement;

        // æ•´ç†è³‡æ–™æ ¼å¼ä»¥ç¬¦åˆæˆ‘å€‘çš„ state çµæ§‹
        setWeather({
          source: 'CWA',
          // éå» 10 åˆ†é˜é›¨é‡ (-99.0 ä»£è¡¨ç„¡è³‡æ–™/å„€å™¨æ•…éšœï¼Œè¦–ç‚º 0)
          min10: Math.max(0, rainElement.Now.Precipitation), 
          // éå» 1 å°æ™‚é›¨é‡
          rain: Math.max(0, rainElement.Past1hr.Precipitation),
          // 24å°æ™‚ç´¯ç©
          dayRain: Math.max(0, rainElement.Past24hr.Precipitation),
          stationName: stationData.StationName,
          obsTime: stationData.ObsTime.DateTime
        });
        setDataSource('CWA');
        return true;
      }
    } catch (e) {
      console.error("CWA API Error:", e);
      return false; // å¤±æ•—å‰‡å›å‚³ falseï¼Œè®“ç³»çµ±é™ç´šå»æŠ“ Open-Meteo
    }
    return false;
  };

  // 2. æŠ“å– Open-Meteo è³‡æ–™ (å‚™æ¡ˆ)
  const fetchOpenMeteo = async () => {
    try {
      const response = await fetch(
        `https://api.open-meteo.com/v1/forecast?latitude=${currentCourt.lat}&longitude=${currentCourt.lon}&current=precipitation,rain,showers,weather_code&timezone=auto`
      );
      const data = await response.json();
      setWeather({
        source: 'Open-Meteo',
        rain: data.current.rain + data.current.showers, // åˆä½µé™£é›¨èˆ‡é›¨é‡
        precipitation: data.current.precipitation,
        obsTime: data.current.time
      });
      setDataSource('Open-Meteo');
    } catch (err) {
      console.error("Open-Meteo å¤±æ•—", err);
      setError("ç„¡æ³•å–å¾—æ°£è±¡è³‡æ–™");
    }
  };

  // æ•´åˆæŠ“å–é‚è¼¯
  const fetchWeather = async () => {
    const cwaSuccess = await fetchCwaData();
    if (!cwaSuccess) {
      await fetchOpenMeteo();
    }
  };

  const refreshAll = () => {
    setLoading(true);
    setImageUrl(`${currentCourt.camUrl}?t=${Date.now()}`);
    fetchWeather();
    const now = new Date();
    setLastUpdated(now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }));
  };

  const handleImageLoad = () => {
    if (imgRef.current) {
      try {
        const canvas = document.createElement('canvas');
        canvas.width = imgRef.current.width;
        canvas.height = imgRef.current.height;
        const ctx = canvas.getContext('2d');
        if (ctx) {
          ctx.drawImage(imgRef.current, 0, 0);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;
          let r, g, b, avg;
          let colorSum = 0;
          for (let i = 0, len = data.length; i < len; i += 4) {
            r = data[i];
            g = data[i + 1];
            b = data[i + 2];
            avg = Math.floor((r + g + b) / 3);
            colorSum += avg;
          }
          const brightness = Math.floor(colorSum / (imgRef.current.width * imgRef.current.height));
          setBrightness(brightness);
        }
      } catch (e) {
        setBrightness(-1); 
      }
    }
    setLoading(false);
  };

  useEffect(() => {
    const interval = setInterval(refreshAll, 60000);
    return () => clearInterval(interval);
  }, []);

  // --- åˆ¤æ–·é‚è¼¯ ---
  let isRaining = false;
  let rainValue = 0;

  if (weather) {
    if (weather.source === 'CWA') {
      // æ°£è±¡å±€é‚è¼¯ï¼šåªè¦ 10 åˆ†é˜å…§æœ‰é›¨ï¼Œæˆ– 1 å°æ™‚å…§ç´¯ç© > 0.5 (é¿å…å„€å™¨èª¤å·®)
      isRaining = (weather.min10 > 0) || (weather.rain > 0);
      rainValue = weather.rain;
    } else {
      // Open-Meteo é‚è¼¯
      isRaining = (weather.rain > 0 || weather.precipitation > 0);
      rainValue = weather.rain || weather.precipitation;
    }
  }
  
  const isDark = brightness !== -1 && brightness < 40; 
  
  let status = "analyzing";
  let statusText = "åˆ†æä¸­...";
  let statusColor = "bg-slate-700";

  if (!loading && weather) {
    if (isRaining) {
      status = "wet";
      statusText = "è§€æ¸¬åˆ°é™é›¨ï¼Œå»ºè­°æ”¾æ£„ ğŸŒ§ï¸";
      statusColor = "bg-red-600";
    } else if (isDark) {
      status = "dark";
      statusText = "å¤ªæš—äº†ï¼Œæ³¨æ„å®‰å…¨ ğŸŒ‘";
      statusColor = "bg-yellow-600";
    } else {
      status = "go";
      statusText = "å ´åœ°ç›®å‰ä¹¾ç‡¥ï¼ğŸ€";
      statusColor = "bg-emerald-600";
    }
  }

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100 font-sans flex flex-col items-center p-4">
      {/* æ¨™é¡Œå€ */}
      <div className="w-full max-w-md text-center mb-6 mt-4">
        <h1 className="text-2xl font-bold tracking-wider flex items-center justify-center gap-2">
          <span className="text-orange-500 text-3xl">ğŸ€</span> 
          çƒå ´å¤©æ°£å“¨å…µ
        </h1>
        <p className="text-slate-400 text-sm mt-1">
          å³æ™‚ç›£æ§èˆ‡é™é›¨åˆ†æ
        </p>
      </div>

      {/* çƒå ´åˆ‡æ› Tabs */}
      <div className="w-full max-w-md flex bg-slate-900 rounded-lg p-1 mb-6 border border-slate-800">
        {COURTS.map((court, index) => (
          <button
            key={court.id}
            onClick={() => setCurrentCourtIndex(index)}
            className={`flex-1 py-2 text-sm font-medium rounded-md transition-all duration-300 ${
              currentCourtIndex === index 
                ? 'bg-orange-600 text-white shadow-lg' 
                : 'text-slate-400 hover:text-white hover:bg-slate-800'
            }`}
          >
            {court.name}
          </button>
        ))}
      </div>

      {/* ç•¶å‰çƒå ´è³‡è¨Š */}
      <div className="w-full max-w-md flex items-center gap-2 mb-4 text-slate-300">
        <MapPin size={16} className="text-orange-400" />
        <span className="font-bold text-lg">{currentCourt.name}</span>
        <div className="ml-auto flex flex-col items-end">
          <span className="text-xs text-slate-500 bg-slate-900 px-2 py-0.5 rounded border border-slate-800">
            {currentCourt.subName}
          </span>
          {/* é¡¯ç¤ºç›®å‰ä½¿ç”¨çš„è³‡æ–™ä¾†æº */}
          <span className="text-[10px] text-slate-600 mt-1">
             è³‡æ–™ä¾†æº: {dataSource === 'CWA' ? 'ä¸­å¤®æ°£è±¡å±€ (CWA)' : 'Open-Meteo'}
          </span>
        </div>
      </div>

      {/* ç‹€æ…‹å¤§ç‡ˆ */}
      <div className={`w-full max-w-md rounded-2xl p-6 mb-6 text-center transition-all duration-500 shadow-lg border border-white/10 ${statusColor}`}>
        <h2 className="text-4xl font-black mb-2 drop-shadow-md text-white">
          {loading ? "..." : (status === "go" ? "GO!" : "NO")}
        </h2>
        <p className="text-lg font-medium opacity-90 text-white/90">{statusText}</p>
      </div>

      {/* å³æ™‚å½±åƒå€ */}
      <div className="w-full max-w-md bg-slate-900 rounded-xl overflow-hidden shadow-2xl border border-slate-800 mb-6 relative group aspect-video">
        <div className="absolute top-2 left-2 bg-black/60 px-2 py-1 rounded text-xs text-white flex items-center gap-1 z-10 backdrop-blur-sm">
          <Video size={12} /> å³æ™‚ç›£æ§
        </div>
        
        <img 
          ref={imgRef}
          src={imageUrl} 
          alt="Live Camera" 
          crossOrigin="anonymous"
          className={`w-full h-full object-cover transition-opacity duration-300 ${loading ? 'opacity-50' : 'opacity-100'}`}
          onLoad={handleImageLoad}
          onError={() => setError('ç„¡æ³•è¼‰å…¥å½±åƒ')}
        />
        
        {error && (
          <div className="absolute inset-0 flex items-center justify-center bg-slate-900/80 text-red-400">
            <AlertCircle className="mr-2" /> {error}
          </div>
        )}
      </div>

      {/* æ•¸æ“šå„€è¡¨æ¿ */}
      <div className="w-full max-w-md grid grid-cols-2 gap-4">
        {/* é™é›¨æ©Ÿç‡ */}
        <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 flex flex-col items-center">
          <div className="text-slate-400 text-xs mb-1 flex items-center gap-1">
            <Umbrella size={12}/> 
            {weather?.source === 'CWA' ? 'å¯¦æ¸¬é›¨é‡ (1hr)' : 'é ä¼°é›¨é‡'}
          </div>
          <div className="flex items-center gap-2">
            {isRaining ? <CloudRain className="text-blue-400" /> : <Sun className="text-orange-400" />}
            <span className="text-2xl font-bold text-slate-200">
              {weather ? (rainValue > 0 ? "æœ‰é›¨" : "ä¹¾ç‡¥") : "--"}
            </span>
          </div>
          <div className="text-xs text-slate-500 mt-1 font-mono">
             {rainValue} mm {weather?.min10 !== undefined && weather.min10 > 0 && `(è¿‘10åˆ†: ${weather.min10}mm)`}
          </div>
        </div>

        {/* äº®åº¦åµæ¸¬ */}
        <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 flex flex-col items-center">
          <div className="text-slate-400 text-xs mb-1 flex items-center gap-1">
            <Sun size={12}/> ç’°å¢ƒäº®åº¦
          </div>
          <div className="flex items-center gap-2">
            {brightness < 50 ? <Moon className="text-yellow-200" /> : <Sun className="text-yellow-500" />}
            <span className="text-2xl font-bold text-slate-200">
              {brightness === -1 ? "N/A" : brightness}
            </span>
          </div>
          <div className="text-xs text-slate-500 mt-1">
            {brightness === -1 ? "åƒ…ä¾›ç›®è¦–" : (brightness > 80 ? "å…‰ç·šå……è¶³" : "å…‰ç·šè¼ƒæš—")}
          </div>
        </div>
      </div>

      {/* åº•éƒ¨æ§åˆ¶åˆ— */}
      <div className="mt-8 flex items-center gap-4 text-slate-400 text-xs">
        <span className="font-mono opacity-60">UPDATED: {lastUpdated}</span>
        <button 
          onClick={refreshAll}
          className="p-2 bg-slate-800 rounded-full hover:bg-slate-700 active:scale-95 transition-all text-orange-500 border border-slate-700"
        >
          <RefreshCw size={16} className={loading ? "animate-spin" : ""} />
        </button>
      </div>
    </div>
  );
}
