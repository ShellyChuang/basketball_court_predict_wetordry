<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç±ƒçƒå ´å¤©æ°£å“¨å…µ</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ React å’Œ Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- å¼•å…¥ Lucide Icons (ä½¿ç”¨å…¨å±€è®Šæ•¸) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { background-color: #0f172a; color: white; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- è¨­å®šå€ ---
        // å¡«å…¥ä½ çš„ä¸­å¤®æ°£è±¡å±€ API Key (è‹¥ç‚ºç©ºå­—ä¸²ï¼Œå°‡è‡ªå‹•ä½¿ç”¨ Open-Meteo å…è²»åœ–è³‡)
        const CWA_API_KEY = "CWA-CF841C96-88BC-4532-82C4-B7BF7AD68209"; 

        // çƒå ´è³‡æ–™
        const COURTS = [
            {
                id: 'xinsheng',
                name: 'æ–°ç”Ÿå…¬åœ’ç±ƒçƒå ´',
                subName: 'å°åŒ—å¸‚ æ°‘æ—å»ºåœ‹è·¯å£ç›£æ¸¬é»',
                lat: 25.0683,
                lon: 121.5332,
                camUrl: "https://c01.twipcam.com/cam/snapshot/tpe-000241.jpg",
                stationId: "C0A9F0", 
            },
            {
                id: 'chongyang',
                name: 'é‡é™½æ©‹å ¤å¤–ç±ƒçƒå ´',
                subName: 'æ–°åŒ—å¸‚ ä¸‰é‡å€é‡é™½æ©‹ç›£æ¸¬é»',
                lat: 25.0845,
                lon: 121.4992,
                camUrl: "https://c01.twipcam.com/cam/snapshot/nwt-000249.jpg",
                stationId: "C0AD30",
            }
        ];

        // ç°¡å–®çš„åœ–ç¤ºå…ƒä»¶ (ä½¿ç”¨ Lucide çš„ SVG å­—ä¸²æˆ–è‡ªè¡Œç¹ªè£½ï¼Œç‚ºæ±‚ç©©å®šé€™è£¡ç”¨ SVG)
        const Icons = {
            CloudRain: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M16 14v6"/><path d="M8 14v6"/><path d="M12 16v6"/></svg>,
            Sun: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Moon: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
            Video: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></svg>,
            RefreshCw: ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            MapPin: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            Umbrella: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12a10.06 10.06 0 0 0-20 0Z"/><path d="M12 12v8a2 2 0 0 0 4 0"/><path d="M12 2v1"/></svg>,
            AlertCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
        };

        function App() {
            const [currentCourtIndex, setCurrentCourtIndex] = useState(0);
            const currentCourt = COURTS[currentCourtIndex];

            const [imageUrl, setImageUrl] = useState(`${currentCourt.camUrl}?t=${Date.now()}`);
            const [weather, setWeather] = useState(null);
            const [brightness, setBrightness] = useState(0);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [lastUpdated, setLastUpdated] = useState('');
            const [dataSource, setDataSource] = useState('Open-Meteo');
            
            const imgRef = useRef(null);

            useEffect(() => {
                setLoading(true);
                setWeather(null);
                setBrightness(0);
                setError('');
                refreshAll();
            }, [currentCourtIndex]);

            // 1. æŠ“å–æ°£è±¡å±€è³‡æ–™
            const fetchCwaData = async () => {
                if (!CWA_API_KEY) return false;
                try {
                    const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0002-001?Authorization=${CWA_API_KEY}&StationId=${currentCourt.stationId}`;
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.success === "true" && data.records.Station.length > 0) {
                        const stationData = data.records.Station[0];
                        const rainElement = stationData.RainfallElement;
                        setWeather({
                            source: 'CWA',
                            min10: Math.max(0, rainElement.Now.Precipitation), 
                            rain: Math.max(0, rainElement.Past1hr.Precipitation),
                            dayRain: Math.max(0, rainElement.Past24hr.Precipitation),
                        });
                        setDataSource('CWA');
                        return true;
                    }
                } catch (e) {
                    console.error("CWA API Error:", e);
                    return false;
                }
                return false;
            };

            // 2. æŠ“å– Open-Meteo
            const fetchOpenMeteo = async () => {
                try {
                    const response = await fetch(
                        `https://api.open-meteo.com/v1/forecast?latitude=${currentCourt.lat}&longitude=${currentCourt.lon}&current=precipitation,rain,showers,weather_code&timezone=auto`
                    );
                    const data = await response.json();
                    setWeather({
                        source: 'Open-Meteo',
                        rain: data.current.rain + data.current.showers,
                        precipitation: data.current.precipitation,
                    });
                    setDataSource('Open-Meteo');
                } catch (err) {
                    setError("ç„¡æ³•å–å¾—æ°£è±¡è³‡æ–™");
                }
            };

            const fetchWeather = async () => {
                const cwaSuccess = await fetchCwaData();
                if (!cwaSuccess) await fetchOpenMeteo();
            };

            const refreshAll = () => {
                setLoading(true);
                setImageUrl(`${currentCourt.camUrl}?t=${Date.now()}`);
                fetchWeather();
                const now = new Date();
                setLastUpdated(now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }));
            };

            const handleImageLoad = () => {
                if (imgRef.current) {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = imgRef.current.width;
                        canvas.height = imgRef.current.height;
                        const ctx = canvas.getContext('2d');
                        if (ctx) {
                            ctx.drawImage(imgRef.current, 0, 0);
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const data = imageData.data;
                            let colorSum = 0;
                            for (let i = 0, len = data.length; i < len; i += 4) {
                                let avg = Math.floor((data[i] + data[i + 1] + data[i + 2]) / 3);
                                colorSum += avg;
                            }
                            const brightness = Math.floor(colorSum / (imgRef.current.width * imgRef.current.height));
                            setBrightness(brightness);
                        }
                    } catch (e) {
                        setBrightness(-1); 
                    }
                }
                setLoading(false);
            };

            useEffect(() => {
                const interval = setInterval(refreshAll, 60000);
                return () => clearInterval(interval);
            }, []);

            // åˆ¤æ–·é‚è¼¯
            let isRaining = false;
            let rainValue = 0;
            if (weather) {
                if (weather.source === 'CWA') {
                    isRaining = (weather.min10 > 0) || (weather.rain > 0);
                    rainValue = weather.rain;
                } else {
                    isRaining = (weather.rain > 0 || weather.precipitation > 0);
                    rainValue = weather.rain || weather.precipitation;
                }
            }
            
            const isDark = brightness !== -1 && brightness < 40; 
            
            let status = "analyzing";
            let statusText = "åˆ†æä¸­...";
            let statusColor = "bg-slate-700";

            if (!loading && weather) {
                if (isRaining) {
                    status = "wet";
                    statusText = "è§€æ¸¬åˆ°é™é›¨ï¼Œå»ºè­°æ”¾æ£„ ğŸŒ§ï¸";
                    statusColor = "bg-red-600";
                } else if (isDark) {
                    status = "dark";
                    statusText = "å¤ªæš—äº†ï¼Œæ³¨æ„å®‰å…¨ ğŸŒ‘";
                    statusColor = "bg-yellow-600";
                } else {
                    status = "go";
                    statusText = "å ´åœ°ç›®å‰ä¹¾ç‡¥ï¼ğŸ€";
                    statusColor = "bg-emerald-600";
                }
            }

            return (
                <div className="min-h-screen font-sans flex flex-col items-center p-4">
                    {/* æ¨™é¡Œå€ */}
                    <div className="w-full max-w-md text-center mb-6 mt-4">
                        <h1 className="text-2xl font-bold tracking-wider flex items-center justify-center gap-2 text-white">
                            <span className="text-3xl">ğŸ€</span> 
                            çƒå ´å¤©æ°£å“¨å…µ
                        </h1>
                        <p className="text-slate-400 text-sm mt-1">å³æ™‚ç›£æ§èˆ‡é™é›¨åˆ†æ</p>
                    </div>

                    {/* åˆ‡æ›çƒå ´ */}
                    <div className="w-full max-w-md flex bg-slate-900 rounded-lg p-1 mb-6 border border-slate-800">
                        {COURTS.map((court, index) => (
                            <button
                                key={court.id}
                                onClick={() => setCurrentCourtIndex(index)}
                                className={`flex-1 py-2 text-sm font-medium rounded-md transition-all duration-300 ${
                                    currentCourtIndex === index 
                                        ? 'bg-orange-600 text-white shadow-lg' 
                                        : 'text-slate-400 hover:text-white hover:bg-slate-800'
                                }`}
                            >
                                {court.name}
                            </button>
                        ))}
                    </div>

                    {/* ç•¶å‰çƒå ´è³‡è¨Š */}
                    <div className="w-full max-w-md flex items-center gap-2 mb-4 text-slate-300">
                        <Icons.MapPin className="text-orange-400 w-4 h-4" />
                        <span className="font-bold text-lg">{currentCourt.name}</span>
                        <div className="ml-auto flex flex-col items-end">
                            <span className="text-xs text-slate-500 bg-slate-900 px-2 py-0.5 rounded border border-slate-800">
                                {currentCourt.subName}
                            </span>
                            <span className="text-[10px] text-slate-600 mt-1">
                                è³‡æ–™ä¾†æº: {dataSource === 'CWA' ? 'ä¸­å¤®æ°£è±¡å±€ (CWA)' : 'Open-Meteo'}
                            </span>
                        </div>
                    </div>

                    {/* ç‹€æ…‹å¤§ç‡ˆ */}
                    <div className={`w-full max-w-md rounded-2xl p-6 mb-6 text-center transition-all duration-500 shadow-lg border border-white/10 ${statusColor}`}>
                        <h2 className="text-4xl font-black mb-2 drop-shadow-md text-white">
                            {loading ? "..." : (status === "go" ? "GO!" : "NO")}
                        </h2>
                        <p className="text-lg font-medium opacity-90 text-white/90">{statusText}</p>
                    </div>

                    {/* å³æ™‚å½±åƒ */}
                    <div className="w-full max-w-md bg-slate-900 rounded-xl overflow-hidden shadow-2xl border border-slate-800 mb-6 relative group aspect-video">
                        <div className="absolute top-2 left-2 bg-black/60 px-2 py-1 rounded text-xs text-white flex items-center gap-1 z-10 backdrop-blur-sm">
                            <Icons.Video className="w-3 h-3"/> å³æ™‚ç›£æ§
                        </div>
                        <img 
                            ref={imgRef}
                            src={imageUrl} 
                            alt="Live Camera" 
                            crossOrigin="anonymous"
                            className={`w-full h-full object-cover transition-opacity duration-300 ${loading ? 'opacity-50' : 'opacity-100'}`}
                            onLoad={handleImageLoad}
                            onError={() => setError('ç„¡æ³•è¼‰å…¥å½±åƒ')}
                        />
                        {error && (
                            <div className="absolute inset-0 flex items-center justify-center bg-slate-900/80 text-red-400">
                                <Icons.AlertCircle className="mr-2 w-4 h-4" /> {error}
                            </div>
                        )}
                    </div>

                    {/* å„€è¡¨æ¿ */}
                    <div className="w-full max-w-md grid grid-cols-2 gap-4">
                        <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 flex flex-col items-center">
                            <div className="text-slate-400 text-xs mb-1 flex items-center gap-1">
                                <Icons.Umbrella className="w-3 h-3"/> 
                                {weather?.source === 'CWA' ? 'å¯¦æ¸¬é›¨é‡ (1hr)' : 'é ä¼°é›¨é‡'}
                            </div>
                            <div className="flex items-center gap-2">
                                {isRaining ? <Icons.CloudRain className="text-blue-400 w-6 h-6" /> : <Icons.Sun className="text-orange-400 w-6 h-6" />}
                                <span className="text-2xl font-bold text-slate-200">
                                    {weather ? (rainValue > 0 ? "æœ‰é›¨" : "ä¹¾ç‡¥") : "--"}
                                </span>
                            </div>
                            <div className="text-xs text-slate-500 mt-1 font-mono">
                                {rainValue} mm
                            </div>
                        </div>

                        <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 flex flex-col items-center">
                            <div className="text-slate-400 text-xs mb-1 flex items-center gap-1">
                                <Icons.Sun className="w-3 h-3"/> ç’°å¢ƒäº®åº¦
                            </div>
                            <div className="flex items-center gap-2">
                                {brightness < 50 ? <Icons.Moon className="text-yellow-200 w-6 h-6" /> : <Icons.Sun className="text-yellow-500 w-6 h-6" />}
                                <span className="text-2xl font-bold text-slate-200">
                                    {brightness === -1 ? "N/A" : brightness}
                                </span>
                            </div>
                            <div className="text-xs text-slate-500 mt-1">
                                {brightness === -1 ? "åƒ…ä¾›ç›®è¦–" : (brightness > 80 ? "å…‰ç·šå……è¶³" : "åæš—")}
                            </div>
                        </div>
                    </div>

                    <div className="mt-8 flex items-center gap-4 text-slate-400 text-xs">
                        <span className="font-mono opacity-60">UPDATED: {lastUpdated}</span>
                        <button 
                            onClick={refreshAll}
                            className="p-2 bg-slate-800 rounded-full hover:bg-slate-700 active:scale-95 transition-all text-orange-500 border border-slate-700"
                        >
                            <Icons.RefreshCw className={`w-4 h-4 ${loading ? "animate-spin" : ""}`} />
                        </button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
