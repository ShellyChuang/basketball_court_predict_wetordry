<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç±ƒçƒå ´å¤©æ°£å“¨å…µ AI Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <!-- å¼•å…¥ TensorFlow.js å’Œ COCO-SSD æ¨¡å‹ -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    
    <style>
        body { background-color: #0f172a; color: white; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); }
        @keyframes pulse-red {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        .live-dot {
            width: 8px; height: 8px; background-color: #ef4444; border-radius: 50%;
            display: inline-block; animation: pulse-red 1.5s infinite ease-in-out;
        }
        iframe { border: 0; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .meter-fill { transition: width 0.5s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- è¨­å®šå€ ---
        const CWA_API_KEY = "CWA-CF841C96-88BC-4532-82C4-B7BF7AD68209"; 

        const COURTS = [
            {
                id: 'xinsheng',
                name: 'æ–°ç”Ÿå…¬åœ’ç±ƒçƒå ´',
                subName: 'Live å½±ç‰‡ä¸²æµ',
                lat: 25.06864561047287,
                lon: 121.5326769316123,
                type: 'hls', 
                url: "https://jtmctrafficcctv3.gov.taipei/NVR/81662387-c95d-429d-8e7b-0f9a2126c9af/live.m3u8",
                stationId: "C0A9F0", 
            },
            {
                id: 'chongyang',
                name: 'é‡é™½æ©‹å ¤å¤–ç±ƒçƒå ´',
                subName: 'Live å½±ç‰‡ä¸²æµ',
                lat: 25.082149680144155,
                lon: 121.50035843449184,
                type: 'hls', 
                url: "https://cctvatis4.ntpc.gov.tw/hls/C000249/live.m3u8",
                stationId: "C0AD30",
            }
        ];

        const Icons = {
            CloudRain: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M16 14v6"/><path d="M8 14v6"/><path d="M12 16v6"/></svg>,
            Sun: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Moon: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
            Video: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></svg>,
            RefreshCw: ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            MapPin: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            Umbrella: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12a10.06 10.06 0 0 0-20 0Z"/><path d="M12 12v8a2 2 0 0 0 4 0"/><path d="M12 2v1"/></svg>,
            ClockRain: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 6v6l4 2"/><circle cx="12" cy="12" r="10"/></svg>,
            AlertCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Droplets: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.8-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"/></svg>,
            Wind: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></svg>,
            Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
            Zap: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            Brain: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>
        };

        function App() {
            const [currentCourtIndex, setCurrentCourtIndex] = useState(0);
            const currentCourt = COURTS[currentCourtIndex];
            
            const [weather, setWeather] = useState(null);
            const [loading, setLoading] = useState(true);
            const [lastUpdated, setLastUpdated] = useState('');
            const [imageUrl, setImageUrl] = useState(''); 
            
            // AI è¦–è¦ºåˆ†æç‹€æ…‹ (å«ç‰©ä»¶åµæ¸¬)
            const [cvData, setCvData] = useState({ 
                brightness: 0, 
                reflection: 0, 
                available: false,
                umbrellas: 0, // é›¨å‚˜æ•¸é‡
                persons: 0,   // è¡Œäººæ•¸é‡
                motorcycles: 0, // æ©Ÿè»Šæ•¸é‡
                isObjModelLoaded: false // æ¨¡å‹æ˜¯å¦è¼‰å…¥
            });
            
            const mediaRef = useRef(null);
            const hlsRef = useRef(null);
            const modelRef = useRef(null); // å­˜æ”¾ COCO-SSD æ¨¡å‹

            // 1. åˆå§‹åŒ–æ¨¡å‹
            useEffect(() => {
                const loadModel = async () => {
                    try {
                        console.log("Loading COCO-SSD model...");
                        const model = await cocoSsd.load();
                        modelRef.current = model;
                        setCvData(prev => ({ ...prev, isObjModelLoaded: true }));
                        console.log("Model loaded!");
                    } catch (err) {
                        console.error("Failed to load model", err);
                    }
                };
                loadModel();
            }, []);

            // 2. åˆå§‹åŒ–èˆ‡å®šæ™‚å™¨
            useEffect(() => {
                setLoading(true);
                setWeather(null);
                // é‡ç½® CV æ•¸æ“š (ä¿ç•™æ¨¡å‹è¼‰å…¥ç‹€æ…‹)
                setCvData(prev => ({ ...prev, brightness: 0, reflection: 0, umbrellas: 0, persons: 0, motorcycles: 0, available: false }));
                fetchWeather();
                
                if (hlsRef.current) { hlsRef.current.destroy(); hlsRef.current = null; }
                
                if (currentCourt.type === 'image') {
                    setImageUrl(`${currentCourt.url}?t=${Date.now()}`);
                    setLoading(false);
                } else if (currentCourt.type === 'iframe') {
                    setLoading(false);
                }

                const weatherInterval = setInterval(() => { fetchWeather(); }, 60000);
                
                // ç•«é¢æ›´æ–° (3ç§’)
                const mediaInterval = setInterval(() => {
                    if (currentCourt.type === 'image') {
                        setImageUrl(`${currentCourt.url}?t=${Date.now()}`);
                    } 
                }, 3000);

                // AI åˆ†æ (5ç§’) - é¿å…éåº¦æ¶ˆè€—æ•ˆèƒ½
                const aiInterval = setInterval(() => {
                    const el = mediaRef.current;
                    if (el) {
                        // ç¢ºä¿å…ƒç´ æœ‰è¼‰å…¥
                        const isReady = (currentCourt.type === 'image' && el.complete) || 
                                      (currentCourt.type === 'hls' && !el.paused);
                        if (isReady) {
                            analyzeFrame(el);
                            detectObjects(el); // åŸ·è¡Œç‰©ä»¶åµæ¸¬
                        }
                    }
                }, 5000);

                return () => {
                    clearInterval(weatherInterval);
                    clearInterval(mediaInterval);
                    clearInterval(aiInterval);
                    if (hlsRef.current) hlsRef.current.destroy();
                };
            }, [currentCourtIndex]);

            // HLS Video
            useEffect(() => {
                if (currentCourt.type === 'hls' && mediaRef.current) {
                    const video = mediaRef.current;
                    if (Hls.isSupported()) {
                        const hls = new Hls();
                        hls.loadSource(currentCourt.url);
                        hls.attachMedia(video);
                        hls.on(Hls.Events.MANIFEST_PARSED, () => {
                            video.play().catch(e => console.log("Autoplay blocked", e));
                            setLoading(false);
                        });
                        hls.on(Hls.Events.ERROR, (event, data) => {
                            if (data.fatal) hls.startLoad();
                        });
                        hlsRef.current = hls;
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                        video.src = currentCourt.url;
                        video.addEventListener('loadedmetadata', () => { video.play(); setLoading(false); });
                    }
                }
            }, [currentCourt.type, currentCourt.url]);

            // AI: åƒç´ åˆ†æ (åå…‰/äº®åº¦)
            const analyzeFrame = (source) => {
                try {
                    const canvas = document.createElement('canvas');
                    canvas.width = 320;
                    canvas.height = 180;
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    ctx.drawImage(source, 0, 0, canvas.width, canvas.height);
                    
                    const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = frame.data;
                    const pixelCount = data.length / 4;

                    let totalLum = 0;
                    let highLightCount = 0;
                    const startPixel = Math.floor(pixelCount * 0.5); 
                    const step = 40; 

                    for (let i = startPixel * 4; i < data.length; i += step) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        const lum = 0.299 * r + 0.587 * g + 0.114 * b;
                        totalLum += lum;
                        if (lum > 245) highLightCount++;
                    }

                    const avgLum = totalLum / (pixelCount * 0.5 / (step / 4));
                    const reflectionRatio = (highLightCount / (pixelCount * 0.5 / (step / 4))) * 100;

                    setCvData(prev => ({
                        ...prev,
                        brightness: avgLum,
                        reflection: reflectionRatio,
                        available: true
                    }));

                } catch (e) {
                    setCvData(prev => ({ ...prev, available: false }));
                }
            };

            // AI: ç‰©ä»¶åµæ¸¬ (é›¨å‚˜/äºº/è»Š)
            const detectObjects = async (source) => {
                if (!modelRef.current) return;
                
                try {
                    // è¨­å®šåµæ¸¬ä¿¡å¿ƒé–€æª» 0.5
                    const predictions = await modelRef.current.detect(source);
                    
                    let umbrellas = 0;
                    let persons = 0;
                    let motorcycles = 0;

                    predictions.forEach(prediction => {
                        if (prediction.class === 'umbrella') umbrellas++;
                        if (prediction.class === 'person') persons++;
                        if (prediction.class === 'motorcycle') motorcycles++;
                    });

                    setCvData(prev => ({
                        ...prev,
                        umbrellas,
                        persons,
                        motorcycles
                    }));
                    
                } catch (e) {
                    console.warn("Object detection failed (likely CORS or format issue)", e);
                }
            };

            const fetchWeather = async () => {
                let rain10m = 0;
                let rain1h = 0;
                let humidity = 0;
                let wind = 0;
                let sourceLabel = 'Open-Meteo';

                try {
                    const omRes = await fetch(
                        `https://api.open-meteo.com/v1/forecast?latitude=${currentCourt.lat}&longitude=${currentCourt.lon}&current=relative_humidity_2m,wind_speed_10m&minutely_15=precipitation&forecast_days=1&timezone=auto`
                    );
                    const omData = await omRes.json();
                    humidity = omData.current.relative_humidity_2m;
                    wind = omData.current.wind_speed_10m;
                    
                    const now = new Date();
                    const times = omData.minutely_15.time;
                    let closestIndex = 0;
                    let minDiff = Infinity;
                    times.forEach((t, i) => {
                        const diff = Math.abs(now - new Date(t));
                        if (diff < minDiff) { minDiff = diff; closestIndex = i; }
                    });
                    
                    rain10m = omData.minutely_15.precipitation[closestIndex] || 0;
                    for (let k = 0; k < 4; k++) {
                        if (closestIndex - k >= 0) {
                            rain1h += omData.minutely_15.precipitation[closestIndex - k];
                        }
                    }
                    sourceLabel = 'Open-Meteo (å¤šç¶­æ•¸æ“š)';
                } catch (e) { console.error("OpenMeteo Error", e); }

                if (CWA_API_KEY) {
                    try {
                        const cwaRes = await fetch(`https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0002-001?Authorization=${CWA_API_KEY}&StationId=${currentCourt.stationId}`);
                        const cwaData = await cwaRes.json();
                        if (cwaData.success === "true" && cwaData.records.Station.length > 0) {
                            const station = cwaData.records.Station[0].RainfallElement;
                            const past10 = station.Past10Min ? station.Past10Min.Precipitation : 0;
                            const nowRain = station.Now ? station.Now.Precipitation : 0;
                            const past1hr = station.Past1hr ? station.Past1hr.Precipitation : 0;
                            rain10m = Math.max(0, past10, nowRain);
                            rain1h = Math.max(0, past1hr);
                            sourceLabel = 'CWA (å³æ™‚å¯¦æ¸¬)';
                        }
                    } catch (e) { console.error("CWA Error", e); }
                }

                setWeather({ rain10m, rain1h, humidity, wind, sourceLabel });
            };

            const manualRefresh = () => {
                setLoading(true);
                fetchWeather();
                if (currentCourt.type === 'image') setImageUrl(`${currentCourt.url}?t=${Date.now()}`);
                const now = new Date();
                setLastUpdated(now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }));
            };

            // ğŸŒŸ æœ€çµ‚åˆ¤å®š (ç‰©ç†æ•¸æ“š + AI è¦–è¦º + ç‰©ä»¶åµæ¸¬)
            const getDecision = () => {
                if (!weather) return { code: 'analyzing', text: 'åˆ†æä¸­...', reason: 'æ­£åœ¨è®€å–æ•¸æ“š...' };

                const now = new Date();
                const hour = now.getHours();
                const isNight = hour >= 18 || hour < 6;
                const isLightingHours = hour >= 17 && hour < 22;

                const isRainingNow = weather.rain10m > 0;
                const isRainedRecently = weather.rain1h > 0;
                const isVeryHumid = weather.humidity >= 85;
                const isNoWind = weather.wind < 5;
                const isWeatherDry = !isRainingNow && !isRainedRecently && weather.humidity < 80;

                // AI è¦–è¦ºå› å­
                const cvWetRisk = cvData.available && isNight && cvData.reflection > 8.0 && !isWeatherDry;
                
                // ç‰©ä»¶åµæ¸¬å› å­ (New!)
                const hasUmbrella = cvData.umbrellas > 0;
                // å¦‚æœæ˜¯ç™½å¤©ï¼Œæœ‰åµæ¸¬åˆ°é›¨å‚˜ï¼Œä¸è«–æ°£è±¡å¦‚ä½•ï¼Œè¦–ç‚ºæœ‰é›¨
                // å¦‚æœæ˜¯æ™šä¸Šï¼Œè¦æ¯”è¼ƒå°å¿ƒ (å¯èƒ½æ˜¯æ”¤è²©å‚˜?)ï¼Œä½†æ²³æ¿±é€šå¸¸è¼ƒå°‘æ”¤è²©ï¼Œå¯è¦–ç‚ºé«˜é¢¨éšª
                const aiDetectedRain = hasUmbrella;

                // --- æ±ºç­–æ¨¹ ---
                
                // 1. æœ€å¼·åˆ¤å®šï¼šçœ‹åˆ°é›¨å‚˜ (Visual Confirmation)
                if (aiDetectedRain) {
                    return { code: 'wet', text: 'æœ‰äººæ’å‚˜', color: 'bg-red-600', reason: `1. AI åµæ¸¬åˆ° ${cvData.umbrellas} æŠŠé›¨å‚˜ â˜‚ï¸\n2. ç¾å ´æ¥µé«˜æ©Ÿç‡æ­£åœ¨ä¸‹é›¨\n3. æ°£è±¡æ•¸æ“šåƒ…ä¾›åƒè€ƒã€‚` };
                }

                // 2. æ¬¡å¼·åˆ¤å®šï¼šå„€å™¨æ¸¬åˆ°é›¨
                if (isRainingNow) {
                    return { code: 'wet', text: 'NO', color: 'bg-red-600', reason: `1. ç¾åœ¨æœ‰é›¨ (è¿‘10åˆ†é˜ ${weather.rain10m}mm)\n2. çµ•å°ä¸å®œæ‰“çƒã€‚` };
                }

                // 3. æ»¯å¾Œä¹¾ç‡¥åˆ¤å®š
                if (isRainedRecently) {
                    if (isNight) {
                        return { code: 'damp', text: 'NO (åœ°æ¿•)', color: 'bg-red-500', reason: `1. 1å°æ™‚å…§æ›¾ä¸‹é›¨ (${weather.rain1h}mm)\n2. æ™šä¸Šç„¡æ—¥ç…§ï¼Œåœ°æ¿é›£ä¹¾\n3. æ¿•æ»‘å±éšªï¼` };
                    }
                    if (isVeryHumid && isNoWind) {
                        return { code: 'damp', text: 'ä¸å»ºè­°', color: 'bg-blue-600', reason: `1. å‰›ä¸‹éé›¨ä¸”æ¿•æ°£é‡ (${weather.humidity}%)\n2. ç„¡é¢¨åŠ©ä¹¾ï¼Œå ´åœ°ä»å¯èƒ½ç©æ°´ã€‚` };
                    }
                    return { code: 'damp', text: 'è§€å¯Ÿä¸­', color: 'bg-yellow-600', reason: `1. é›¨å‰›åœ (1hrå…§ç´¯ç© ${weather.rain1h}mm)\n2. é¢¨é€Ÿä¸éŒ¯ï¼Œå¯èƒ½æ­£åœ¨é¢¨ä¹¾\n3. è«‹ç¾å ´ç¢ºèªã€‚` };
                }

                if (cvWetRisk) {
                    return { code: 'wet', text: 'ç–‘ä¼¼ç©æ°´', color: 'bg-orange-600', reason: `1. æ°£è±¡ç„¡é›¨ï¼Œä½†æ¿•åº¦é«˜\n2. AI åµæ¸¬åˆ°è·¯é¢å¼·çƒˆåå…‰\n3. åˆ¤æ–·ç‚ºç©æ°´æœªé€€ã€‚` };
                }

                if (isVeryHumid && isNoWind && isNight) {
                    return { code: 'damp', text: 'æè¿”æ½®', color: 'bg-blue-500', reason: `1. ç„¡é›¨ä½†æ¿•åº¦æ¥µé«˜ (${weather.humidity}%)\n2. ç„¡é¢¨ä¸”å¤œé–“ï¼Œåœ°æ¿å¯èƒ½å‡çµéœ²æ°´(åæ½®)ã€‚` };
                }

                if (isLightingHours) {
                    return { code: 'go', text: 'GO!', color: 'bg-emerald-600', reason: `1. 1å°æ™‚å…§å‡ç„¡é›¨\n2. AI æœªåµæ¸¬åˆ°é›¨å‚˜\n3. æ­£å€¼å¤œé–“ç…§æ˜æ™‚æ®µï¼Œè¡å§ï¼` };
                }

                if (isNight && !isLightingHours) {
                     return { code: 'dark', text: 'å¤ªæš—äº†', color: 'bg-slate-800', reason: `1. åœ°ä¹¾ä½†å·²éç…§æ˜æ™‚é–“\n2. è¦–ç·šä¸è‰¯ã€‚` };
                }

                return { code: 'go', text: 'GO!', color: 'bg-emerald-600', reason: `1. 10åˆ†é˜èˆ‡1å°æ™‚å…§çš†ç„¡é›¨\n2. AI æœªç™¼ç¾é›¨å‚˜\n3. é©åˆé‹å‹•ï¼` };
            };

            const decision = getDecision();

            return (
                <div className="min-h-screen font-sans flex flex-col items-center p-4 pb-20">
                    <div className="w-full max-w-md text-center mb-6 mt-4">
                        <h1 className="text-2xl font-bold tracking-wider flex items-center justify-center gap-2 text-white">
                            <span className="text-3xl">ğŸ€</span> çƒå ´å¤©æ°£å“¨å…µ
                        </h1>
                        <p className="text-slate-400 text-sm mt-1">æ°£è±¡ x AI è¦–è¦º x ç‰©ä»¶åµæ¸¬</p>
                    </div>

                    <div className="w-full max-w-md flex bg-slate-900 rounded-lg p-1 mb-6 border border-slate-800">
                        {COURTS.map((court, index) => (
                            <button
                                key={court.id}
                                onClick={() => setCurrentCourtIndex(index)}
                                className={`flex-1 py-2 text-sm font-medium rounded-md transition-all duration-300 ${
                                    currentCourtIndex === index 
                                        ? 'bg-orange-600 text-white shadow-lg' 
                                        : 'text-slate-400 hover:text-white hover:bg-slate-800'
                                }`}
                            >
                                {court.name}
                            </button>
                        ))}
                    </div>

                    <div className="w-full max-w-md flex items-center gap-2 mb-4 text-slate-300">
                        <Icons.MapPin className="text-orange-400 w-4 h-4" />
                        <span className="font-bold text-lg">{currentCourt.name}</span>
                        <div className="ml-auto flex flex-col items-end">
                            <span className="text-xs text-slate-500 bg-slate-900 px-2 py-0.5 rounded border border-slate-800">
                                {currentCourt.subName}
                            </span>
                        </div>
                    </div>

                    <div className={`w-full max-w-md rounded-2xl p-6 mb-6 text-center transition-all duration-500 shadow-lg border border-white/10 ${decision.color || 'bg-slate-700'}`}>
                        <h2 className="text-5xl font-black mb-2 drop-shadow-md text-white">
                            {loading ? "..." : decision.text}
                        </h2>
                    </div>

                    {/* å½±åƒå€ (æ”¯æ´ Video, Iframe, Image) */}
                    <div className="w-full max-w-md bg-slate-900 rounded-xl overflow-hidden shadow-2xl border border-slate-800 mb-6 relative group aspect-video">
                        <div className="absolute top-2 left-2 bg-black/60 px-2 py-1 rounded text-xs text-white flex items-center gap-2 z-10 backdrop-blur-sm">
                            <span className="live-dot"></span>
                            <span>{cvData.isObjModelLoaded ? 'AI DETECTING' : 'LOADING AI...'}</span>
                        </div>
                        {currentCourt.type === 'iframe' ? (
                            <iframe src={currentCourt.url} className="w-full h-full object-cover" allow="autoplay; fullscreen" scrolling="no"></iframe>
                        ) : currentCourt.type === 'hls' ? (
                            <video ref={mediaRef} className="w-full h-full object-cover" autoPlay muted playsInline crossOrigin="anonymous"></video>
                        ) : (
                            <img ref={mediaRef} src={imageUrl} className="w-full h-full object-cover" crossOrigin="anonymous" alt="Live View" />
                        )}
                    </div>

                    {/* æ•¸æ“šå„€è¡¨æ¿ */}
                    <div className="w-full max-w-md grid grid-cols-4 gap-2 mb-4">
                        <div className="bg-slate-900 p-2 rounded-xl border border-slate-800 flex flex-col items-center justify-center">
                            <div className="text-slate-400 text-[10px] mb-1 flex items-center gap-1"><Icons.Umbrella className="w-3 h-3"/> è¿‘10åˆ†</div>
                            <div className="text-lg font-bold text-slate-200">{weather ? weather.rain10m : '-'}</div>
                        </div>
                        <div className={`bg-slate-900 p-2 rounded-xl border border-slate-800 flex flex-col items-center justify-center ${weather?.rain1h > 0 ? 'border-red-500/50 bg-red-900/10' : ''}`}>
                            <div className="text-slate-400 text-[10px] mb-1 flex items-center gap-1"><Icons.ClockRain className="w-3 h-3"/> è¿‘1å°æ™‚</div>
                            <div className="text-lg font-bold text-slate-200">{weather ? weather.rain1h.toFixed(1) : '-'}</div>
                        </div>
                        <div className={`p-2 rounded-xl border border-slate-800 flex flex-col items-center justify-center ${weather?.humidity > 90 ? 'bg-blue-900/30' : 'bg-slate-900'}`}>
                            <div className="text-slate-400 text-[10px] mb-1 flex items-center gap-1"><Icons.Droplets className="w-3 h-3"/> æ¿•åº¦%</div>
                            <div className="text-lg font-bold text-slate-200">{weather ? weather.humidity : '-'}</div>
                        </div>
                        <div className="bg-slate-900 p-2 rounded-xl border border-slate-800 flex flex-col items-center justify-center">
                            <div className="text-slate-400 text-[10px] mb-1 flex items-center gap-1"><Icons.Wind className="w-3 h-3"/> é¢¨é€Ÿ</div>
                            <div className="text-lg font-bold text-slate-200">{weather ? weather.wind : '-'}</div>
                        </div>
                    </div>

                    {/* AI è¦–è¦ºå„€è¡¨æ¿ (æ–°å¢ç‰©ä»¶åµæ¸¬çµæœ) */}
                    {cvData.available && (
                        <div className="w-full max-w-md bg-slate-900/50 p-3 rounded-xl border border-slate-700/50 mb-4 text-xs">
                            <div className="flex items-center gap-2 mb-3 text-orange-400 font-bold uppercase tracking-wider border-b border-slate-700 pb-1">
                                <Icons.Brain className="w-3 h-3"/> AI ç¾å ´åµæ¸¬ (æ¯5ç§’)
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-slate-400">è·¯é¢åå…‰</span>
                                        <span className="font-mono text-orange-400">{cvData.reflection.toFixed(1)}%</span>
                                    </div>
                                    <div className="w-full bg-slate-800 rounded-full h-1 overflow-hidden">
                                        <div className={`h-1 rounded-full meter-fill ${cvData.reflection > 8 ? 'bg-red-500' : 'bg-blue-400'}`} style={{width: `${Math.min(cvData.reflection * 10, 100)}%`}}></div>
                                    </div>
                                </div>
                                
                                <div className="space-y-1">
                                    <div className={`flex justify-between items-center ${cvData.umbrellas > 0 ? 'text-red-400 font-bold' : 'text-slate-400'}`}>
                                        <span>â˜‚ï¸ é›¨å‚˜åµæ¸¬</span>
                                        <span>{cvData.umbrellas}</span>
                                    </div>
                                    <div className="flex justify-between items-center text-slate-400">
                                        <span>ğŸš¶ è¡Œäººåµæ¸¬</span>
                                        <span>{cvData.persons}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="w-full max-w-md bg-slate-800/50 rounded-lg p-4 border border-slate-700/50">
                        <div className="flex items-center gap-2 text-slate-300 mb-2 border-b border-slate-700 pb-2">
                            <Icons.Zap className="w-4 h-4 text-yellow-400" />
                            <span className="font-bold text-sm">ç¶œåˆç ”åˆ¤ä¾æ“š</span>
                        </div>
                        <div className="text-xs text-slate-400 whitespace-pre-line leading-relaxed">
                            {decision.reason}
                        </div>
                    </div>

                    <div className="mt-8 flex items-center justify-center gap-4 text-slate-500 text-xs">
                        <span className="font-mono">UPDATED: {lastUpdated}</span>
                        <button onClick={manualRefresh} className="p-2 bg-slate-800 rounded-full hover:bg-slate-700 text-orange-500">
                            <Icons.RefreshCw className={`w-4 h-4 ${loading ? "animate-spin" : ""}`} />
                        </button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
